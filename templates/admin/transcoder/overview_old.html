{% extends "admin/base_site.html" %}
{% load static transcoder_extras %}
{% load static %}


{% block title %}IP Transcoder Overview{% endblock %}

{% block content %}
  <h1>IP Transcoder – System Overview</h1>

  <p>
    This page summarises what the system can do for each channel.
  </p>

  <ul>
    <li><strong>Recording:</strong> Uses <code>Record</code> schedules to save TS files to disk.</li>
    <li><strong>Time-shift playback:</strong> Uses <code>Playback (delayed)</code> schedules
      plus the channel's <code>TimeShiftProfile</code> to output a delayed UDP stream
      (unicast or multicast).
    </li>
    <li><strong>Archive playback:</strong> Recorded files can be used later for manual replay
      or HLS/VOD features.
    </li>
  </ul>

  <hr>

  {% for ch in channels %}
    {% with scheds=schedules_by_channel|get_item:ch.id %}
      <div style="margin-bottom: 2rem; padding: 1rem; border: 1px solid #ddd; border-radius: 4px;">
        <h2>
          Channel {{ ch.id }} – {{ ch.name }}
        </h2>

        <table class="grp-table" style="width: 100%; margin-bottom: 1rem;">
          <tbody>
          <tr>
            <th style="width: 20%;">Input source</th>
            <td><code>{{ ch.input_url }}</code></td>
          </tr>
          <tr>
            <th>Time-shift profile</th>
            <td>
              {% if ch.timeshift_profile %}
                {% with p=ch.timeshift_profile %}
                  Enabled: <strong>{{ p.enabled|yesno:"Yes,No" }}</strong><br>
                  Delay: <strong>{{ p.delay_minutes }}</strong> minutes<br>
                  Output UDP URL: <code>{{ p.output_udp_url }}</code>
                {% endwith %}
              {% else %}
                <em>No TimeShiftProfile configured</em>
              {% endif %}
            </td>
          </tr>
          </tbody>
        </table>

        <h3>Recording schedules (Record)</h3>
        {% if scheds.record %}
          <table class="grp-table" style="width: 100%; margin-bottom: 1rem;">
            <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Active days</th>
              <th>Time window</th>
              <th>Enabled</th>
            </tr>
            </thead>
            <tbody>
            {% for rs in scheds.record %}
              <tr>
                <td>{{ rs.id }}</td>
                <td><a href="{% url 'admin:transcoder_recurringschedule_change' rs.id %}">{{ rs.name }}</a></td>
                <td>{{ rs.weekdays_text }}</td>
                <td>{{ rs.start_time }} – {{ rs.end_time }}</td>
                <td>{{ rs.enabled|yesno:"Yes,No" }}</td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p><em>No recording schedules for this channel.</em></p>
        {% endif %}

        <h3>Playback schedules (Delayed)</h3>
        {% if scheds.playback %}
          <table class="grp-table" style="width: 100%; margin-bottom: 1rem;">
            <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Active days</th>
              <th>Time window</th>
              <th>Enabled</th>
            </tr>
            </thead>
            <tbody>
            {% for rs in scheds.playback %}
              <tr>
                <td>{{ rs.id }}</td>
                <td><a href="{% url 'admin:transcoder_recurringschedule_change' rs.id %}">{{ rs.name }}</a></td>
                <td>{{ rs.weekdays_text }}</td>
                <td>{{ rs.start_time }} – {{ rs.end_time }}</td>
                <td>{{ rs.enabled|yesno:"Yes,No" }}</td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p><em>No playback schedules for this channel.</em></p>
        {% endif %}

        {% if scheds.other %}
          <h3>Other schedules</h3>
          <ul>
            {% for rs in scheds.other %}
              <li>
                #{{ rs.id }} – {{ rs.name }} (purpose={{ rs.purpose }})
              </li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>
    {% endwith %}
  {% empty %}
    <p>No channels configured yet.</p>
  {% endfor %}

{% endblock %}
